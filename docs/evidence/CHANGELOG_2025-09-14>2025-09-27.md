# ECS無停止デプロイ（2025-09-14 → 2025-09-27）

目的: Fargate/ECS を ALB 配下で無停止更新。証跡で可観測・再現可能に。

## 主要変更

* Infra（ecs.tf）

  * deployment_circuit_breaker=on, health_check_grace_period_seconds=60
  * task_role_arn 追加 + s3:GetObject 付与（MODEL_S3_URI）
* API（api/app.py）

  * 起動時のモデルロードを「可能なら」に緩和、S3フェッチ、/metrics 追加
* Config（pyproject.toml）

  * boto3 追加、sklearn バージョン整合（警告解消）
* Makefile

  * /tmp で Terraform 実行、tg-health / svc-events / metrics 追加

## 証跡

* ALB DNS: `mlops-api-alb-1702823157.us-west-2.elb.amazonaws.com`
* `/health` 200: `docs/evidence/20250927_054140_health.txt`
* Target Health: healthy（`make tg-health` 出力）
* CloudWatch Logs: Uvicorn 起動ログ + /health アクセス記録

## ロールアウト

1. GH Actions で `:latest` push
2. `aws ecs update-service --force-new-deployment`
3. `make tg-health` が healthy になったら `make evidence && make metrics`

## リスクと対策

* モデル未配置: /predict 初回 503、/reload or 先読み実行で回避
* 依存差異: sklearn pin、Artifacts にメタ付与
* ロールバック: Circuit breaker + 旧TaskDefinitionへの手動戻し

## 次アクション

* `/metrics` をダッシュボード集約
* モデル配布に署名/ハッシュ検証
